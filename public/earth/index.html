<html>
    <head>
        <title>ðŸŒŽ</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta http-equiv="X-Frame-Options" content="sameorigin"> <!-- meta is not reliable, use http header instead -->

        <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
        <script>if(!document.querySelector('link[href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"]').length)document.write('<link rel="stylesheet" href="css/font-awesome.min.css">')</script>
        
        <link rel="stylesheet" href="css/temperature.css">
        <style>
            body { margin: 0; }
            #label{
                width: 30%;
                height: 40px;
                opacity: .6;
                left: 35%;
                font-size: 32px;
                background-color: #666;
                position: absolute;
                bottom: 100px;
                text-align: center;
                border-radius: 5px;
            }
            #label:hover{
                opacity: 1;
            }
            #menu:hover{
                height: 300px;
                width: 200px;
                transition-delay: 0s;
            }
            #date{
                width: 100px;
            }
            #player{
                position: absolute;
                bottom: 55px;
                left: 8%;
            }
            #play-button, #pause-button {
                color: #fff;
            }
            #area-panel{
                position: absolute;
                display: flex;
                justify-content: space-around;  
                flex-direction: column;
                width: 150px;
                height: 200px;
                background-color: #fff;
                top: 10px;
                left: 10px;
            }
            #progress-bar{
                height: 12px;
                width: 40%;
                position: absolute;
                bottom: 30px;
                left: 30%;
                border-radius: 6px;
                background: linear-gradient( to right, #fff, 1%, #777, 1%, #777);
            }
        </style>
    </head>
    <body>
        <div id="container"></div>
        <div id="label">2016/8/9</div>
        <div id="progress-bar"></div>
        <div id="player">
            <i id="play-button" class="fa fa-play fa-3x" onclick="switchPlay(true)"></i>
            <i id="pause-button" class="fa fa-pause fa-3x" style="display: none" onclick="switchPlay(false)"></i>
        </div>
        <div id="area-panel">
            <span onclick="setGeoCam(25, 115)">East Aisa</span>
            <span onclick="setGeoCam(45, -100)">North America</span>
            <span onclick="setGeoCam(-10, -60)">South America</span>
            <span onclick="setGeoCam(50, 5)">Europe</span>
            <span onclick="setGeoCam(15, 15)">Africa</span>
            <span onclick="setGeoCam(-25, 135)">Australia</span>
        </div>
        <div id="t">
            <div id="t-legend">
                <div id="t-legend-text">
                    <span>40</span>
                    <span>20</span>
                    <span>0</span>
                    <span>-20</span>
                    <span>-40</span>
                </div>
                <div id="t-legend-celsius">Â°C</div>
            </div>
        </div>
        <script src="js/Tween.js"></script>
        <script scr="//cdnjs.cloudflare.com/ajax/libs/three.js/r79/three.min.js"></script><script>window.THREE||document.write('<script src="js/three.min.js"><\/script>');</script>
        <script src="js/OrbitControls.js"></script>
        <script>
            // utils
            function fillz(num, width){

                num = +num;
                num = num.toString();
                while(num.length < width)
                    num = '0' + num
                return num
            }

            // angles in degrees
            function sph2cart(radius, theta, phi){

                theta = theta * Math.PI / 180
                phi = phi * Math.PI / 180
                return {
                    x: radius * Math.sin(phi) * Math.cos(theta),
                    y: radius * Math.sin(phi) * Math.sin(theta),
                    z: radius * Math.cos(phi)
                }
            }

            function cart2sph(x, y, z){

                return {
                    r: Math.hypot( x, y, z),
                    t: Math.atan2( y, x)/ Math.PI*180,
                    p: Math.acos( z/ Math.hypot( x, y, z))/ Math.PI*180
                }
            }
        </script>
        <script>
            var play = document.getElementById('play-button')
            var pause = document.getElementById('pause-button')
            var play_id, currentMap='200908.0100_t_001';

            function switchPlay(isPlayClicked){

                if (isPlayClicked) {

                    play.style = 'disPlay: none'
                    pause.style = ''
                    playMaps();

                } else {

                    play.style = ''
                    pause.style = 'disPlay: none'
                    clearTimeout(play_id);

                }
            }


            var bar = document.getElementById('progress-bar')
            function setProgress( fraction){

                var percent = parseInt( fraction*100) + '%'
                bar.style = `background: linear-gradient( to right, #fff, ${percent}, #777, ${percent}, #777);`

            }

            bar.addEventListener( 'click', function(e) {

                setPlay( (e.layerX+10)/ bar.clientWidth)

            })

            function setPlay( fraction) {

                var n = Math.max( 1, Math.min( 55, Math.floor( fraction*55)))
                ,   d = Math.floor( n/4) + 1
                ,   t = (n)%4

                setMap( toTmptUrl( tmpt.year, tmpt.month, d, t, tmpt.height))

            }

            function setGeoCam( lat, lng){

                setSphereCam( lng+90, 90-lat);

            }

            function setSphereCam( theta, phi){

                var start = cart2sph(camera.position.z, camera.position.x, camera.position.y)
                console.log(start)
                var tween = new TWEEN.Tween(start).to({
                    r: 8, t: theta, p: phi
                }, 500)
                .onUpdate(function() {
                    var point = sph2cart(start.r, start.t, start.p)
                    camera.position.set( point.y, point.z, point.x);
                    camera.lookAt( new THREE.Vector3(0,0,0));
                }).start();
                
            }

            function setShadow(on){

                directLight.intensity  = +on;
                ambientLight.intensity =+!on +.3;

            }

            var container = document.getElementById('container')
            var loader = new THREE.TextureLoader();
            var maps={}, itemN = 0
            
            // init
            var scene = new THREE.Scene();
            var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );

            var renderer = new THREE.WebGLRenderer();
            container.appendChild(renderer.domElement)
            renderer.setSize( window.innerWidth, window.innerHeight );

            var orbits = new THREE.OrbitControls( camera, renderer.domElement );
            orbits.maxDistance = 12;
            orbits.minDistance = 6;
            orbits.enablePan = false
            orbits.autoRotate = true
            orbits.autoRotateSpeed = 1

            var directLight = new THREE.DirectionalLight( 0xcccccc, 1)
            var ambientLight    = new THREE.AmbientLight( 0xcccccc, .3)
            directLight.position.set(5,3,5)
            scene.add( directLight )
            scene.add( ambientLight )
            // earth
            var geometry = new THREE.SphereGeometry(5, 32, 32)
            var material = new THREE.MeshPhongMaterial()
            material.map = THREE.ImageUtils.loadTexture('textures/earthmap1k.jpg')
            material.bumpMap = THREE.ImageUtils.loadTexture('textures/earthbump1k.jpg')
            material.bumpScale = 0.1
            material.specularMap    = THREE.ImageUtils.loadTexture('textures/earthspec1k.jpg')
            loader.load('textures/earthmap4k.jpg', (t)=>material.map=t)
            loader.load('textures/earthbump4k.jpg', (t)=>material.bumpMap=t)
            var earthMesh = new THREE.Mesh(geometry, material)
            scene.add(earthMesh)
            // shell
            var geometryShell = new THREE.SphereGeometry(5.001, 32, 32)
            var materialShell = new THREE.MeshBasicMaterial()
            materialShell.map = THREE.ImageUtils.loadTexture('images2/200908.0100_t_016.png')
            materialShell.transparent = true
            var shellMesh = new THREE.Mesh(geometryShell, materialShell)
            scene.add(shellMesh)

            camera.position.z = 12;

            var tmpt
            var animate = function () {

                requestAnimationFrame( animate );

                renderer.render(scene, camera);
                TWEEN.update()
                orbits.update()

            };

            animate();

            function playMaps() {

                let next = +currentMap.slice( -2)
                next += 16

                if ( next > 63) {

                    next %= 16
                    var nextMap = currentMap.replace(/(\d\d)00_t/, function(s, a) {
                        a = +a + 1
                        return fillz( a, 2) + '00_t'
                    }).slice( 0, -2) + fillz( next, 2)

                } else {

                    var nextMap = currentMap.slice( 0, -2) + next

                }

                setMap( nextMap, playMaps)

            }

        </script>
        <script src="js/dat.gui.min.js"></script>
        <script>
            tmpt = {
                year: 2009,
                month: 8,
                day: 2,
                hour: 0,
                height: 0,
                playInterval: 1000,
                rotationSpeed: 1,
                shadow: true
            }

            function update() {
                setMap( toTmptUrl(tmpt.year, tmpt.month, tmpt.day, tmpt.hour, tmpt.height))
            }

            var gui = new dat.GUI();
            var tgui = gui.addFolder('Temparature')
            tgui.add(tmpt, 'year', [2009])
                .onChange( update);

            tgui.add(tmpt, 'month', [8])
                .onChange( update);

            tgui.add(tmpt, 'day', [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15])
                .onChange( update);

            tgui.add(tmpt, 'hour', {
                '0:00': 0, '6:00': 1, '12:00': 2, '18:00': 3
            }).onChange( update);

            tgui.add(tmpt, 'height', {
            "10": 0, "30": 1, "50": 2, "70": 3, "100": 4, "150": 5, "200": 6, "250": 7, "300": 8, "400": 9, "500": 10, "600": 11, "700": 12, "850":   13, "925": 14, "1000": 15
            }).onChange( update);

            tgui.add(tmpt, 'playInterval', 100, 5000);
            tgui.add(tmpt, 'rotationSpeed', 0, 100)
                .step(1)
                .onChange( function() {
                    orbits.autoRotateSpeed=tmpt.rotationSpeed
                });

            tgui.add(tmpt, 'shadow')
                .onChange( setShadow);

            tgui.open();
        </script>
        <script>
            // fname: no .png posfix
            function setMap(fname, cb){

                function _setMap(t){

                    materialShell.map = t;
                    currentMap = fname;

                    label.innerText = fname.replace(/(\d\d\d\d)(\d\d).(\d\d)00_t_(\d\d\d)/, function(s, y, m, d, se){

                        // 55 datetime in given test data
                        setProgress( ((d-1)*4+ ~~(se/16))/ 55)   // lol
                        return `${+y}/${+m}/${+d} ${~~(se/16)*6}:00`

                    });

                    if(cb) {
                        play_id = setTimeout(cb, tmpt.playInterval);
                    }

                }
            

                if(fname in maps){

                    _setMap( maps[fname])

                }else{

                    let url = 'images2/'+fname+'.png'
                    loader.load(url, (texture)=>{

                        _setMap( maps[fname]=texture)

                    }, (xhr)=>{

                        console.log( (xhr.loaded / xhr.total * 100) + '% loaded')

                    }, (xhr)=>{

                        // what the hell XDD
                        if(cb) tog()
                        else
                        alert('404')

                    })

                }
            }

            function toTmptUrl(y, m, d, t, h){

                y=+y; m=+m; d=+d; t=+t; h=+h;
                let serial = t*16+h
                return `${y}${fillz(m, 2)}.${fillz(d, 2)}00_t_${fillz(serial, 3)}`

            }
        </script>
    </body>
</html>