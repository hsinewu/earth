<html>
    <head>
        <title>ðŸŒŽ</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="X-Frame-Options" content="sameorigin"> <!-- meta is not reliable, use http header instead -->

        <link rel="stylesheet" href="css/temperature.css">
        <style>
            body { margin: 0; background-color: #000;}
            #label{
                width: 30%;
                height: 40px;
                opacity: .6;
                left: 35%;
                font-size: 32px;
                background-color: #666;
                position: absolute;
                bottom: 100px;
                text-align: center;
                border-radius: 5px;

                display: none;
            }
            #label:hover{
                opacity: 1;
            }
            #area-panel{
                position: absolute;
                display: flex;
                justify-content: space-around;  
                flex-direction: column;
                width: 150px;
                height: 200px;
                color: #fff;
                top: 10px;
                left: 10px;
            }
            #play-control {
                position: absolute;
                left: calc(12.5% - 64px);
                bottom: calc(7% - 24px);
                z-index: 2;
            }
            #play-control>svg {
                width: 64px;
                height: 64px;
                fill: #fff;
            }
            #bar {
                position: absolute;
                z-index: 1;
                left: 12.5%;
                bottom: 7%;
                width: 75%;
            }
            input[type=range] {
                background: none;
                outline: none;
            }
            
            #dash-menu {
                position: absolute;
                z-index: 1;
                right: 5%;
                top: 5%;
            }
        </style>
    </head>
    <body>
    <div id="container"></div>

    <div id="label">2016/8/9</div>
    <div id="legend" class="slp">
        <div id="legend-text">
            <span>10 20 30</span>
            <span>980 990 1000 1010 1020</span>
            <span>10 20 30</span>
        </div>
        <div id="legend-unit">
            <span>K</span>
            <span>Pa</span>
            <span>K</span>
        </div>
    </div>
    <div id="play-control">
        <svg viewBox="36 0 36 36">
          <path id="pause-icon" d="M11,10 L17,10 17,26 11,26 M20,10 L26,10 26,26 20,26" />
          <path id="play-icon" d="M47,10 L54,13.74 54,22.25 47,26 M54,13.74 L62,18 62,18 54,22.28" />
        </svg>
    </div>
    <input type="range" name="" id="bar" min=0 max=180 step=1 value=0 oninput="updateViz({pos: +this.value});">
        <div id="area-panel">
            <span onclick="setGeoCam(25, 115)">East Aisa</span>
            <span onclick="setGeoCam(45, -100)">North America</span>
            <span onclick="setGeoCam(-10, -60)">South America</span>
            <span onclick="setGeoCam(50, 5)">Europe</span>
            <span onclick="setGeoCam(15, 15)">Africa</span>
            <span onclick="setGeoCam(-25, 135)">Australia</span>
        </div>
        <script src="js/Tween.js"></script>
        <script scr="//cdnjs.cloudflare.com/ajax/libs/three.js/r79/three.min.js"></script><script>window.THREE||document.write('<script src="js/three.min.js"><\/script>');</script>
        <script src="js/OrbitControls.js"></script>
        <script>
            // utils
            function fillz(num, width) {

                num = +num;
                num = num.toString();
                while(num.length < width)
                    num = '0' + num;
                return num;
            }

            // angles in degrees
            function sph2cart(radius, theta, phi) {

                theta = theta * Math.PI / 180;
                phi = phi * Math.PI / 180;
                return {
                    x: radius * Math.sin(phi) * Math.cos(theta),
                    y: radius * Math.sin(phi) * Math.sin(theta),
                    z: radius * Math.cos(phi)
                };
            }

            function cart2sph(x, y, z) {

                with (Math) {
                    return {
                        r: hypot( x, y, z),
                        t: atan2( y, x)/ PI*180,
                        p: acos( z/ hypot( x, y, z))/ PI*180
                    };
                }
            }
        </script>
        <script>
            var viz = {name: 'r85', item: 'temp2', pos: 0, length: 180, timer_id: 0}, ctrls = {}, setting1 = {}, three = {}, dataset = {};
            function initDOM() {
                ctrls.bar = document.getElementById('bar');
                bar.value = 0;

                var play_ctrl = document.getElementById('play-control'), play_state=true;
                play_ctrl.onclick = function() {
                    if(play_state) {
                        playAnime();
                        play_ctrl.children[0].setAttribute('viewBox', '0 0 36 36');
                    } else {
                        stopAnime();
                        play_ctrl.children[0].setAttribute('viewBox', '36 0 36 36');
                    }
                    play_state = !play_state;
                }
            }

            function updateViz(viz_new) {
                Object.assign( viz, viz_new);
                if(viz.pos != bar.value) bar.value = viz.pos;

                if( viz.pos in three.textures[viz.name][viz.item]) {
                    three.shell.material.map = three.textures[viz.name][viz.item][viz.pos];
                } else {
                    t = three.loader.load(`data/${viz.name}/${viz.item}/${viz.pos}.png`);
                    t.magFilter = THREE.NearestFilter
                    three.shell.material.map =
                        three.textures[viz.name][viz.item][viz.pos] = t;
                        
                }
            }

            function playAnime() {
                var _play = function() {
                    if(viz.pos < viz.length) {
                        var timer_id = setTimeout(_play, setting1.playSpeed)
                        ,   pos = viz.pos + 1;
                        updateViz({pos, timer_id});
                    } else {
                        stopAnime();
                    }
                }
                _play();
            }
            function stopAnime() {
                clearInterval(viz.timer_id);
            }

            function setGeoCam( lat, lng) {

                setSphereCam( lng+90, 90-lat);

            }

            function setSphereCam( theta, phi) {

                var start = cart2sph(three.camera.position.z, three.camera.position.x, three.camera.position.y);
                var tween = new TWEEN.Tween(start).to({
                    r: 8, t: theta, p: phi
                }, 500)
                .onUpdate( function() {
                    var point = sph2cart( start.r, start.t, start.p)
                    three.camera.position.set( point.y, point.z, point.x);
                    three.camera.lookAt( new THREE.Vector3(0,0,0));
                }).start();
                
            }

            function initThree() {
                var container = document.getElementById('container')
                ,   loader = new THREE.TextureLoader()
                ,   textures={};
                
                // init
                var scene = new THREE.Scene()
                ,   camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 )
                ,   renderer = new THREE.WebGLRenderer();

                container.appendChild(renderer.domElement);
                renderer.setSize( window.innerWidth, window.innerHeight );
                camera.position.z = 12;

                var orbits = new THREE.OrbitControls( camera, renderer.domElement );
                orbits.maxDistance = 12;
                orbits.minDistance = 6;
                orbits.enablePan = false;
                orbits.autoRotate = true;   
                orbits.autoRotateSpeed = 1;

                var directLight = new THREE.DirectionalLight( 0xcccccc, 1)
                ,   ambientLight = new THREE.AmbientLight( 0xcccccc, .3);
                directLight.position.set(5,3,5);
                scene.add( directLight );
                scene.add( ambientLight );

                // earth
                var geometry = new THREE.SphereGeometry(5, 32, 32)
                ,   material = new THREE.MeshPhongMaterial();
                material.map = loader.load('textures/earthmap1k.jpg');
                material.bumpMap = loader.load('textures/earthbump1k.jpg');
                material.bumpScale = 0.1;
                material.specularMap = loader.load('textures/earthspec1k.jpg');
                material.map = loader.load('textures/earthmap4k.jpg');
                material.bumpMap = loader.load('textures/earthbump4k.jpg');
                var earthMesh = new THREE.Mesh(geometry, material);
                scene.add(earthMesh);

                // shell
                var geometryShell = new THREE.SphereGeometry(5.001, 32, 32)
                ,   materialShell = new THREE.MeshBasicMaterial();
                materialShell.map = loader.load('data/r85/temp2/0.png');
                materialShell.map.magFilter = THREE.NearestFilter
                materialShell.transparent = true;
                materialShell.opacity = setting1.opacity;
                var shellMesh = new THREE.Mesh(geometryShell, materialShell);
                scene.add(shellMesh);

                // init all [name][item] to []
                for(var name in dataset){
                    var items = dataset[name].items;
                    textures[name] = items.reduce(function(o,n) {
                        o[n] = [];
                        return o;
                    }, {});
                }
                // preload
                for(var i=0; i<180; i++) {
                    textures.r85.temp2[i] = loader.load(`data/r85/temp2/${i}.png`);
                    textures.r85.temp2[i].magFilter = THREE.NearestFilter
                }
                for(var i=0; i<180; i++) {
                    textures.r85.slp[i] = loader.load(`data/r85/slp/${i}.png`);
                    textures.r85.slp[i].magFilter = THREE.NearestFilter
                }

                three.scene = scene;
                three.camera = camera;
                three.renderer = renderer;
                three.loader = loader;
                three.orbits = orbits;
                three.earth = earthMesh;
                three.shell = shellMesh;
                three.textures = textures;
                three.render = ()=>renderer.render(three.scene, three.camera);
                three.onResize = function() {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();

                    renderer.setSize( window.innerWidth, window.innerHeight );
                }
                three.setShadow = function(on) {
                    directLight.intensity  = +on;
                    ambientLight.intensity =+!on +.3;
                }
            }

            function animate() {

                requestAnimationFrame( animate );

                three.render();
                TWEEN.update();
                three.orbits.update();

            };

            window.onload = function() {
                fetch('dataset.json')
                    .then( (r)=>r.text() )
                    .then( (t)=>dataset=JSON.parse(t))
                    .then( function(){
                        initGui();
                        initThree();
                        animate();
                    })
                initDOM();
            }
            window.addEventListener( 'resize', ()=>three.onResize(), false );
        </script>

        <script src="js/dat.gui.min.js"></script>
        <script>
            function initGui() {
                var gui0 = new dat.GUI();

                setting1 = {
                    playSpeed: 450,
                    rotationSpeed: 1,
                    opacity: .6,
                    shadow: true
                };

                var gui1 = gui0.addFolder('general')

                gui1.add(setting1, 'playSpeed', {
                    slow: 1500, average: 450, fast: 140
                });
                gui1.add(setting1, 'rotationSpeed', -25, 25)
                    .step(1)
                    .onChange( (v)=>three.orbits.autoRotateSpeed=v);

                gui1.add(setting1, 'opacity', .0, 1.)
                    .onChange( (v)=>three.shell.material.opacity=v )
                gui1.add(setting1, 'shadow')
                    .onChange( (v)=>three.setShadow(v)); // bind to this

                gui1.open();

                var names = Object.keys(dataset);
                var setting2 = {
                    name: names[0],
                    item: dataset[names[0]].items[0]
                }

                var gui2 = gui0.addFolder('dataset');

                gui2.add(setting2, 'name', names)
                    .onChange( function changeDataset(name) {
                        // update viz state
                        var length = dataset[name].length
                        ,   pos = 0
                        ,   item = dataset[name].items[0]
                        ,   timer_id = 0;
                        updateViz({name, length, pos, item, timer_id});

                        // update drop-down list
                        gui2.__controllers[1].remove()
                        setting2.item = item
                        gui2.add(setting2, 'item', dataset[name].items)
                            .onChange( (item)=>updateViz({item}) );
                    });

                gui2.add(setting2, 'item', ['temp2', 'slp'])
                    .onChange( (item)=>updateViz({item}) );

                gui2.open();
            }
        </script>
    </body>
</html>