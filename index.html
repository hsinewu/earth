<html>
    <head>
        <title>ðŸŒŽ</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="X-Frame-Options" content="sameorigin"> <!-- meta is not reliable, use http header instead -->

        <link rel="stylesheet" href="css/legend.css">
        <link rel="stylesheet" href="css/control.css">
        <style>
            body { margin: 0; background-color: #000;}
        </style>
    </head>
    <body>
    <div id="container"></div>

    <div id="label">2016/8/9</div>
    <div id="legends" class="temp2">
        <div class="legend">
            <div class="legend-text">25 15 5 -5 -15 -25 -35</div>
            <div class="legend-unit">Â°C</div>
        </div>
        <div class="legend">
            <div class="legend-text">1020 1010 1000 990 980</div>
            <div class="legend-unit">Pa</div>
        </div>
        <div class="legend">
            <div class="legend-text">295 265 235 205 175 145</div>
            <div class="legend-unit">K</div>
        </div>
    </div>
    <div id="playCtrl">
        <svg viewBox="36 0 36 36">
          <path id="pause-icon" d="M11,10 L17,10 17,26 11,26 M20,10 L26,10 26,26 20,26" />
          <path id="play-icon" d="M47,10 L54,13.74 54,22.25 47,26 M54,13.74 L62,18 62,18 54,22.28" />
        </svg>
    </div>
    <input type="range" name="" id="bar" min=0 max=180 step=1 value=0 oninput="updateViz({pos: +this.value});">
        <div id="area-panel">
            <div onclick="setGeoCam(25,  115)"> East Aisa     </div>
            <div onclick="setGeoCam(45, -100)"> North America </div>
            <div onclick="setGeoCam(-10, -60)"> South America </div>
            <div onclick="setGeoCam(50,    5)"> Europe        </div>
            <div onclick="setGeoCam(15,   15)"> Africa        </div>
            <div onclick="setGeoCam(-25, 135)"> Australia     </div>
        </div>
        <script src="js/Tween.js"></script>
        <script scr="//cdnjs.cloudflare.com/ajax/libs/three.js/r79/three.min.js"></script><script>window.THREE||document.write('<script src="js/three.min.js"><\/script>');</script>
        <script src="js/OrbitControls.js"></script>
        <script>
            // angles in degrees
            function sph2cart(radius, theta, phi) {

                theta = theta * Math.PI / 180;
                phi = phi * Math.PI / 180;
                return {
                    x: radius * Math.sin(phi) * Math.cos(theta),
                    y: radius * Math.sin(phi) * Math.sin(theta),
                    z: radius * Math.cos(phi)
                };
            }

            function cart2sph(x, y, z) {

                with (Math) {
                    return {
                        r: hypot( x, y, z),
                        t: atan2( y, x)/ PI*180,
                        p: acos( z/ hypot( x, y, z))/ PI*180
                    };
                }
            }

            function datetime(y, m, d, h) {
                if( y<1e3) console.log('year < 1000 not handled')
                var yyyy = '' + y
                var [mm, dd, hh] = [m,d,h].map(function(x) {
                    x = '0' + x
                    return x.length > 2? x.slice(1) : x
                })
                return yyyy + mm + dd + hh
            }

            // or yyyymmddhh
            function deltaHour(yyyymmdd, dh=0) {
                // var yyyy = yyyymmdd.substring(0, 4)
                // ,   mm = yyyymmdd.substring(4, 6)
                // ,   dd = yyyymmdd.substring(6, 8)
                // ,   d = new Date(`${yyyy} ${mm} ${dd}`)
                var [_, yyyy, mm, dd] = /(\d{4})(\d{2})(\d{2})/.exec(yyyymmdd)
                ,   d = new Date(`${yyyy} ${mm} ${dd}`)
                d.setHours( d.getHours() + dh)
                return datetime( d.getFullYear(), d.getMonth()+1, d.getDate(), d.getHours() )
            }

        </script>
        <script>
            var viz = {name: '2016120100', item: 'temp2', pos: 0, timer_id: 0}
            ,   dataset = {names: ['2016120100', '2016120200', '2016120300', '2016120400', '2016120500', '2016120600', '2016120700', '2016120800', '2016120900', '2016121000'], items:['aprs', 'slm', 'tsw', 'slp', 'precip', 'temp2', 'ws', 'qvi', 'disch', 'seaice', 'sn']}
            ,   setting1 = {}, three = {}, reqs = {};

            function initDOM() {
                bar.value = 0;

                var play_state=true;
                playCtrl.onclick = function() {
                    if(viz.pos==180) return;
                    if(play_state) {
                        forwardPlay();
                        playCtrl.children[0].setAttribute('viewBox', '0 0 36 36');
                    } else {
                        clearInterval(viz.timer_id);
                        playCtrl.children[0].setAttribute('viewBox', '36 0 36 36');
                    }
                    play_state = !play_state;
                }
            }

            function updateViz(viz_new) {
                Object.assign( viz, viz_new);
                if(viz.pos != bar.value) bar.value = viz.pos;
                legends.className = viz.item;

                three.load(viz.name, viz.item, viz.pos)
            }

            function forwardPlay() {

                if(viz.pos < 180) {
                    var timer_id = setTimeout(forwardPlay, setting1.playSpeed)
                    ,   pos = viz.pos + 1;
                    updateViz({pos, timer_id});
                } else {
                    // stopPlay
                    clearInterval(viz.timer_id);
                }

            }

            var setGeoCam = (lat, lng) => setSphereCam( lng+90, 90-lat)

            function setSphereCam( theta, phi) {

                var start = cart2sph(three.camera.position.z, three.camera.position.x, three.camera.position.y);
                var tween = new TWEEN.Tween(start).to({
                    r: 8, t: theta, p: phi
                }, 500)
                .onUpdate( function() {
                    var point = sph2cart( start.r, start.t, start.p)
                    three.camera.position.set( point.y, point.z, point.x);
                    three.camera.lookAt( new THREE.Vector3(0,0,0));
                }).start();
                
            }

            function initThree() {
                var container = document.getElementById('container')
                ,   loader = new THREE.TextureLoader()
                ,   textures={};
                
                // init
                var scene = new THREE.Scene()
                ,   camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 )
                ,   renderer = new THREE.WebGLRenderer();

                container.appendChild(renderer.domElement);
                renderer.setSize( window.innerWidth, window.innerHeight );
                camera.position.z = 12;

                var orbits = new THREE.OrbitControls( camera, renderer.domElement );
                orbits.maxDistance = 12;
                orbits.minDistance = 6;
                orbits.enablePan = false;
                orbits.autoRotate = true;   
                orbits.autoRotateSpeed = 1;

                var directLight = new THREE.DirectionalLight( 0xcccccc, 1)
                ,   ambientLight = new THREE.AmbientLight( 0xcccccc, .3);
                directLight.position.set(5,3,5);
                scene.add( directLight );
                scene.add( ambientLight );

                // earth
                var geometry = new THREE.SphereGeometry(5, 128, 128)
                ,   material = new THREE.MeshPhongMaterial();
                material.map = loader.load('textures/earthmap1k.jpg');
                material.bumpMap = loader.load('textures/earthbump1k.jpg');
                material.bumpScale = 0.1;
                material.specularMap = loader.load('textures/earthspec1k.jpg');
                material.map = loader.load('textures/earthmap4k.jpg');
                material.bumpMap = loader.load('textures/earthbump4k.jpg');
                var earthMesh = new THREE.Mesh(geometry, material);
                scene.add(earthMesh);

                // shell
                var geometryShell = new THREE.SphereGeometry(5.001, 128, 128)
                ,   materialShell = new THREE.MeshBasicMaterial();
                materialShell.map = loader.load(`data/${viz.name}/${viz.item}/${viz.name}.png`);
                materialShell.map.magFilter = THREE.NearestFilter
                materialShell.transparent = true;
                materialShell.opacity = setting1.opacity;
                var shellMesh = new THREE.Mesh(geometryShell, materialShell);
                scene.add(shellMesh);

                // galaxy
                var geometryGalaxy = new THREE.SphereGeometry(900, 128, 128)
                ,   materialGalaxy = new THREE.MeshBasicMaterial();
                materialGalaxy.map = loader.load('textures/galaxy.png');
                materialGalaxy.side = THREE.BackSide;
                var galaxyMesh = new THREE.Mesh(geometryGalaxy, materialGalaxy);
                scene.add(galaxyMesh);

                three.camera = camera;
                three.update = function(){
                    renderer.render(scene, camera);
                    orbits.update();
                }
                three.onResize = function() {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();

                    renderer.setSize( window.innerWidth, window.innerHeight );
                }
                three.setShadow = function(on) {
                    directLight.intensity  = +on;
                    ambientLight.intensity =+!on +.3;
                }
                three.load = function(name, item, pos) {
                    var dt = deltaHour(name, pos*6)
                    var hash = name + item + pos
                    if(!textures[hash]) {
                        textures[hash] = loader.load(`data/${name}/${item}/${dt}.png`)
                        textures[hash].magFilter = THREE.NearestFilter
                    }
                    materialShell.map = textures[hash]

                    // preload test?
                    var dt2 = deltaHour(name, pos*6+6)
                    var hash2 = name + item + (pos+1)
                    if(!textures[hash2]) {
                        textures[hash2] = loader.load(`data/${name}/${item}/${dt2}.png`)
                        textures[hash2].magFilter = THREE.NearestFilter
                    }
                }
                three.__defineSetter__('opacity', v => materialShell.opacity=v )
                three.__defineGetter__('opacity', ()=> materialShell.opacity )
                three.__defineSetter__('autoRotateSpeed', v => orbits.autoRotateSpeed=v )
                three.__defineGetter__('autoRotateSpeed', ()=> orbits.autoRotateSpeed )
            }

            function animate() {

                requestAnimationFrame( animate );

                three.update();
                TWEEN.update();

            };

            function parseRequest() {
                var query = location.search.substr(1)
                ,   params = query.split("&");
                return params
                    .map( (v)=> v.split('=').map(decodeURIComponent) )
                    .reduce( function(ac, [k,v]) { 
                        ac[k] = v;
                        return ac;
                    }, {} );
            }
            
            window.onload = function() {
                reqs = parseRequest()

                initDOM();
                initGui();
                initThree();
                animate();
            }
            window.addEventListener( 'resize', ()=>three.onResize(), false );
        </script>

        <script src="js/dat.gui.min.js"></script>
        <script>
            function initGui() {
                var gui0 = new dat.GUI();

                setting1 = {
                    playSpeed: 450,
                    rotationSpeed: 1,
                    opacity: .6,
                    shadow: true
                };

                var gui1 = gui0.addFolder('General')

                gui1.add(setting1, 'playSpeed', {
                    slow: 1500, average: 450, fast: 140
                });
                gui1.add(setting1, 'rotationSpeed', -25, 25)
                    .step(1)
                    .onChange( v =>three.autoRotateSpeed=v );

                gui1.add(setting1, 'opacity', .0, 1.)
                    .onChange( v =>three.opacity=v );
                gui1.add(setting1, 'shadow')
                    .onChange( v =>three.setShadow(v) );

                var names = dataset.names
                ,   name = names.indexOf( reqs.report) > -1? reqs.report: names[0]
                ,   items = dataset.items
                ,   item = items.indexOf( reqs.variable) > -1? reqs.variable: items[0]
                ,   setting2 = { name, item };

                var gui2 = gui0.addFolder('Dataset');
                gui2.add(setting2, 'name', names)
                    .onChange( name => {
                        var pos = 0
                        ,   timer_id = 0;
                        updateViz({name, pos, timer_id});
                    });

                gui2.add(setting2, 'item', items)
                    .onChange( item =>updateViz({item}) );

                Object.assign( viz, { name, item})  // Three isn't ready, don't updateViz
                legends.className = item

                gui2.open();
            }
        </script>
    </body>
</html>